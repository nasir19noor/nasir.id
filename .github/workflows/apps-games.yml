name: 'Deploy games.nasir.id'

on:
  push:
    paths:
      - 'apps/games/**'
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-games:
    runs-on: [self-hosted, nasir-contabo]

    steps:
    - name: Remove stale nested .git directories
      run: find "$GITHUB_WORKSPACE" -mindepth 2 -name ".git" -exec rm -rf {} + 2>/dev/null || true

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy files to /var/www/html/games.nasir.id
      env:
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        DEPLOY_DIR="/var/www/html/games.nasir.id"

        echo "Creating directory $DEPLOY_DIR if not exists..."
        echo "$SSH_PASSWORD" | sudo -S mkdir -p "$DEPLOY_DIR"

        echo "Removing existing content..."
        echo "$SSH_PASSWORD" | sudo -S rm -rf "$DEPLOY_DIR"/*

        echo "Copying files..."
        echo "$SSH_PASSWORD" | sudo -S cp -r apps/games/. "$DEPLOY_DIR/"

        echo "Setting permissions..."
        echo "$SSH_PASSWORD" | sudo -S chown -R www-data:www-data "$DEPLOY_DIR"

        echo "Deployed successfully to $DEPLOY_DIR"
