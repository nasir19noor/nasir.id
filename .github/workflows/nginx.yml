name: Deploy Nginx Configuration

on:
  push:
    paths:
      - 'nginx/list'
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-nginx:
    runs-on: [self-hosted, nasir-contabo]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Process nginx/list and deploy configurations
      env:
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        if [ ! -f "nginx/list" ]; then
          echo "Error: nginx/list file not found"
          exit 1
        fi

        NGINX_STOPPED=false

        while IFS=',' read -r DOMAIN PORT ROOT || [ -n "$DOMAIN" ]; do
          # Skip empty lines
          [ -z "$DOMAIN" ] && continue

          # Trim whitespace and carriage returns
          DOMAIN=$(echo "$DOMAIN" | tr -d '\r\n ')
          PORT=$(echo "$PORT" | tr -d '\r\n ')
          ROOT=$(echo "$ROOT" | tr -d '\r\n ')

          echo "Checking: $DOMAIN (port: $PORT, root: /$ROOT)"

          if [ -f "/etc/nginx/sites-available/$DOMAIN" ]; then
            echo "domain is exit: $DOMAIN"
          else
            echo "Domain $DOMAIN not found. Setting up..."

            # Stop nginx once to free port 80 for certbot standalone
            if [ "$NGINX_STOPPED" = "false" ]; then
              echo "Stopping nginx for certbot standalone mode..."
              echo "$SSH_PASSWORD" | sudo -S systemctl stop nginx
              NGINX_STOPPED=true
            fi

            # Obtain SSL certificate
            echo "Obtaining SSL certificate for $DOMAIN..."
            echo "$SSH_PASSWORD" | sudo -S certbot certonly --standalone -d "$DOMAIN" --non-interactive --agree-tos --email "admin@nasir.id"

            # Generate nginx config from template
            echo "Creating nginx configuration for $DOMAIN..."
            sed -e "s/\$domain/$DOMAIN/g" \
                -e "s/\$port/$PORT/g" \
                -e "s/\$root/$ROOT/g" \
                nginx/template > "/tmp/nginx-$DOMAIN"
            echo "$SSH_PASSWORD" | sudo -S mv "/tmp/nginx-$DOMAIN" "/etc/nginx/sites-available/$DOMAIN"

            # Enable site
            echo "$SSH_PASSWORD" | sudo -S ln -sf "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
            echo "Configuration deployed for $DOMAIN"
          fi

        done < nginx/list

        if [ "$NGINX_STOPPED" = "true" ]; then
          echo "Testing nginx configuration..."
          echo "$SSH_PASSWORD" | sudo -S nginx -t
          echo "Restarting nginx..."
          echo "$SSH_PASSWORD" | sudo -S systemctl restart nginx
          echo "Nginx restarted successfully"
        else
          echo "No new domains configured. Nginx not restarted."
        fi
