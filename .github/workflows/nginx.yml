name: 'Nginx Configuration'

on:
  push:
    paths:
      - 'nginx/list'
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-nginx:
    runs-on: [self-hosted, nasir-contabo]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Process nginx/list and deploy configurations
      env:
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
      run: |
        if [ ! -f "nginx/list" ]; then
          echo "Error: nginx/list file not found"
          exit 1
        fi

        NGINX_STOPPED=false

        while IFS=',' read -r DOMAIN PORT || [ -n "$DOMAIN" ]; do
          # Skip empty lines
          [ -z "$DOMAIN" ] && continue

          # Trim whitespace and carriage returns
          DOMAIN=$(echo "$DOMAIN" | tr -d '\r\n ')
          PORT=$(echo "$PORT" | tr -d '\r\n ')

          # Use full domain as directory name
          ROOT="var/www/html/$DOMAIN"

          echo "Checking: $DOMAIN (port: $PORT, root: /$ROOT)"

          if [ -f "/etc/nginx/sites-available/$DOMAIN" ]; then
            echo "domain is exit: $DOMAIN"
          else
            echo "Domain $DOMAIN not found. Setting up..."

            # Stop nginx once to free port 80 for certbot standalone
            if [ "$NGINX_STOPPED" = "false" ]; then
              echo "Stopping nginx for certbot standalone mode..."
              echo "$SSH_PASSWORD" | sudo -S systemctl stop nginx
              NGINX_STOPPED=true
            fi

            # Obtain SSL certificate
            echo "Obtaining SSL certificate for $DOMAIN..."
            echo "$SSH_PASSWORD" | sudo -S certbot certonly --standalone -d "$DOMAIN" --non-interactive --agree-tos --email "nasir19noor@gmail.com"

            # Generate nginx config from template
            echo "Creating nginx configuration for $DOMAIN..."
            if [ "$PORT" = "80" ]; then
              # Port 80 = static site: replace proxy_pass block with try_files
              awk -v domain="$DOMAIN" -v root="$ROOT" '
                BEGIN { in_loc=0; d="$" }
                /location \/ \{/ {
                  in_loc=1
                  print "  location / {"
                  print "    try_files " d "uri " d "uri/ =404;"
                  print "  }"
                  next
                }
                in_loc && /^\s*\}/ { in_loc=0; next }
                in_loc { next }
                { gsub(/\$domain/, domain); gsub(/\$root/, root); print }
              ' nginx/template > "/tmp/nginx-$DOMAIN"
            else
              sed -e "s|\$domain|$DOMAIN|g" \
                  -e "s|\$port|$PORT|g" \
                  -e "s|\$root|$ROOT|g" \
                  nginx/template > "/tmp/nginx-$DOMAIN"
            fi
            echo "$SSH_PASSWORD" | sudo -S mv "/tmp/nginx-$DOMAIN" "/etc/nginx/sites-available/$DOMAIN"

            # Create root directory if it doesn't exist
            if [ ! -d "/$ROOT" ]; then
              echo "Creating directory /$ROOT..."
              echo "$SSH_PASSWORD" | sudo -S mkdir -p "/$ROOT"
            else
              echo "Directory /$ROOT already exists"
            fi

            # Enable site
            echo "$SSH_PASSWORD" | sudo -S ln -sf "/etc/nginx/sites-available/$DOMAIN" "/etc/nginx/sites-enabled/$DOMAIN"
            echo "Configuration deployed for $DOMAIN"
          fi

        done < nginx/list

        if [ "$NGINX_STOPPED" = "true" ]; then
          echo "Testing nginx configuration..."
          echo "$SSH_PASSWORD" | sudo -S nginx -t
          echo "Restarting nginx..."
          echo "$SSH_PASSWORD" | sudo -S systemctl restart nginx
          echo "Nginx restarted successfully"
        else
          echo "No new domains configured. Nginx not restarted."
        fi
